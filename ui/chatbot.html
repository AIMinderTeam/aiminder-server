<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Minder ì±—ë´‡ í…ŒìŠ¤íŠ¸</title>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          height: 100vh;
          display: flex;
          justify-content: center;
          align-items: center;
      }

      .chat-container {
          width: 90%;
          max-width: 800px;
          height: 600px;
          background: white;
          border-radius: 20px;
          box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
          display: flex;
          flex-direction: column;
          overflow: hidden;
      }

      .chat-header {
          background: linear-gradient(135deg, #4A90E2, #5C6BC0);
          color: white;
          padding: 20px;
          text-align: center;
          font-size: 20px;
          font-weight: 600;
      }

      .conversation-settings {
          background: #f8f9fa;
          padding: 15px;
          border-bottom: 1px solid #e9ecef;
          display: flex;
          align-items: center;
          gap: 10px;
      }

      .conversation-settings label {
          font-weight: 500;
          color: #495057;
      }

      .conversation-settings input {
          padding: 8px 12px;
          border: 1px solid #ced4da;
          border-radius: 8px;
          font-size: 14px;
          flex: 1;
      }

      .chat-messages {
          flex: 1;
          padding: 20px;
          overflow-y: auto;
          background: #f8f9fa;
      }

      .message {
          margin-bottom: 15px;
          animation: fadeIn 0.3s ease-in;
      }

      @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
      }

      .message.user {
          text-align: right;
      }

      .message.assistant {
          text-align: left;
      }

      .message-bubble {
          display: inline-block;
          max-width: 70%;
          padding: 12px 18px;
          border-radius: 18px;
          font-size: 14px;
          line-height: 1.4;
          word-wrap: break-word;
          white-space: pre-wrap; /* ì¤„ë°”ê¿ˆê³¼ ê³µë°±ì„ ìœ ì§€ */
      }

      .message.user .message-bubble {
          background: linear-gradient(135deg, #4A90E2, #5C6BC0);
          color: white;
      }

      .message.assistant .message-bubble {
          background: white;
          color: #333;
          border: 1px solid #e9ecef;
      }

      .message-input-container {
          padding: 20px;
          background: white;
          border-top: 1px solid #e9ecef;
          display: flex;
          gap: 10px;
      }

      .message-input {
          flex: 1;
          padding: 12px 18px;
          border: 1px solid #ced4da;
          border-radius: 25px;
          font-size: 14px;
          outline: none;
          transition: border-color 0.2s;
      }

      .message-input:focus {
          border-color: #4A90E2;
      }

      .send-button {
          padding: 12px 24px;
          background: linear-gradient(135deg, #4A90E2, #5C6BC0);
          color: white;
          border: none;
          border-radius: 25px;
          cursor: pointer;
          font-weight: 500;
          transition: transform 0.2s;
      }

      .send-button:hover {
          transform: translateY(-2px);
      }

      .send-button:disabled {
          background: #6c757d;
          cursor: not-allowed;
          transform: none;
      }

      .loading {
          display: flex;
          align-items: center;
          gap: 5px;
          padding: 12px 18px;
          background: white;
          border: 1px solid #e9ecef;
          border-radius: 18px;
          max-width: 70%;
      }

      .loading-dots {
          display: flex;
          gap: 3px;
      }

      .loading-dot {
          width: 6px;
          height: 6px;
          background: #6c757d;
          border-radius: 50%;
          animation: loadingPulse 1.4s infinite ease-in-out;
      }

      .loading-dot:nth-child(1) { animation-delay: -0.32s; }
      .loading-dot:nth-child(2) { animation-delay: -0.16s; }

      @keyframes loadingPulse {
          0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
          40% { transform: scale(1); opacity: 1; }
      }

      .error-message {
          color: #dc3545;
          font-size: 12px;
          margin-top: 5px;
          text-align: center;
      }
  </style>
</head>
<body>
<div class="chat-container">
  <div class="chat-header">
    ğŸ¤– AI Minder ì±—ë´‡ í…ŒìŠ¤íŠ¸
  </div>

  <div class="conversation-settings">
    <label for="conversationId">ëŒ€í™” ID:</label>
    <input type="text" id="conversationId" value="test-conversation-1" placeholder="ëŒ€í™” IDë¥¼ ì…ë ¥í•˜ì„¸ìš”">
  </div>

  <div class="chat-messages" id="chatMessages">
    <div class="message assistant">
      <div class="message-bubble">
        ì•ˆë…•í•˜ì„¸ìš”! AI Minder ì±—ë´‡ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?
      </div>
    </div>
  </div>

  <div class="message-input-container">
    <input type="text" class="message-input" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
    <button class="send-button" id="sendButton">ì „ì†¡</button>
  </div>

  <div class="error-message" id="errorMessage"></div>
</div>

<script>
    class ChatBot {
        constructor() {
            this.apiBaseUrl = 'http://localhost:8080'; // Spring Boot ì„œë²„ URL
            this.chatMessages = document.getElementById('chatMessages');
            this.messageInput = document.getElementById('messageInput');
            this.sendButton = document.getElementById('sendButton');
            this.conversationIdInput = document.getElementById('conversationId');
            this.errorMessage = document.getElementById('errorMessage');

            this.initEventListeners();
        }

        initEventListeners() {
            this.sendButton.addEventListener('click', () => this.sendMessage());
            this.messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    this.sendMessage();
                }
            });
        }

        async sendMessage() {
            const message = this.messageInput.value.trim();
            const conversationId = this.conversationIdInput.value.trim();

            if (!message) return;
            if (!conversationId) {
                this.showError('ëŒ€í™” IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
            this.addMessage(message, 'user');
            this.messageInput.value = '';
            this.setLoading(true);
            this.clearError();

            // ë¡œë”© í‘œì‹œ
            const loadingElement = this.showLoading();

            try {
                await this.streamChatResponse(conversationId, message, loadingElement);
            } catch (error) {
                console.error('Chat error:', error);
                this.removeLoading(loadingElement);
                this.showError('ë©”ì‹œì§€ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                this.setLoading(false);
            }
        }

        async streamChatResponse(conversationId, message, loadingElement) {
            const url = `${this.apiBaseUrl}/chat/${encodeURIComponent(conversationId)}`;

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'text/event-stream',
                },
                body: JSON.stringify(message)
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            // ë¡œë”© ì œê±°í•˜ê³  ì‘ë‹µ ë©”ì‹œì§€ ë²„ë¸” ìƒì„±
            this.removeLoading(loadingElement);
            const responseElement = this.addMessage('', 'assistant');
            const messageBubble = responseElement.querySelector('.message-bubble');

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let responseText = '';
            let buffer = '';

            try {
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    buffer += chunk;

                    // ì¤„ë°”ê¿ˆìœ¼ë¡œ ë¶„ë¦¬í•˜ì—¬ ì™„ì „í•œ ë¼ì¸ë“¤ë§Œ ì²˜ë¦¬
                    let lines = buffer.split('\n');

                    // ë§ˆì§€ë§‰ ë¼ì¸ì€ ë¶ˆì™„ì „í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë²„í¼ì— ë³´ê´€
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('data:')) {
                            const data = line.slice(5); // 'data:' ì œê±°

                            if (data === '[DONE]') {
                                return;
                            }

                            // ë¹ˆ data: ë¼ì¸ì€ ì¤„ë°”ê¿ˆìœ¼ë¡œ ì²˜ë¦¬
                            if (data === '') {
                                responseText += '\n';
                            } else {
                                responseText += data;
                            }

                            // í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ ë° ìŠ¤í¬ë¡¤
                            messageBubble.textContent = responseText;
                            this.scrollToBottom();
                        }
                    }
                }

                // ë²„í¼ì— ë‚¨ì€ ë°ì´í„° ì²˜ë¦¬
                if (buffer.startsWith('data:')) {
                    const data = buffer.slice(5);
                    if (data !== '[DONE]' && data.trim() !== '') {
                        responseText += data;
                        messageBubble.textContent = responseText;
                        this.scrollToBottom();
                    }
                }

            } finally {
                reader.releaseLock();
            }
        }

        addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';
            bubbleDiv.textContent = text;

            messageDiv.appendChild(bubbleDiv);
            this.chatMessages.appendChild(messageDiv);
            this.scrollToBottom();

            return messageDiv;
        }

        showLoading() {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message assistant';

            const loadingBubble = document.createElement('div');
            loadingBubble.className = 'loading';
            loadingBubble.innerHTML = `
                    <span>AIê°€ ìƒê° ì¤‘ì…ë‹ˆë‹¤</span>
                    <div class="loading-dots">
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                    </div>
                `;

            loadingDiv.appendChild(loadingBubble);
            this.chatMessages.appendChild(loadingDiv);
            this.scrollToBottom();

            return loadingDiv;
        }

        removeLoading(loadingElement) {
            if (loadingElement && loadingElement.parentNode) {
                loadingElement.parentNode.removeChild(loadingElement);
            }
        }

        setLoading(isLoading) {
            this.sendButton.disabled = isLoading;
            this.messageInput.disabled = isLoading;
            this.conversationIdInput.disabled = isLoading;
        }

        scrollToBottom() {
            this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
        }

        showError(message) {
            this.errorMessage.textContent = message;
            setTimeout(() => this.clearError(), 5000);
        }

        clearError() {
            this.errorMessage.textContent = '';
        }
    }

    // ì±—ë´‡ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', () => {
        new ChatBot();
    });
</script>
</body>
</html>